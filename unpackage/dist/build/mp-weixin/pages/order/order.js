(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/order/order"],{"1c2e":function(e,c,t){"use strict";t.r(c);var n=t("9641"),i=t("daa4");for(var o in i)"default"!==o&&function(e){t.d(c,e,function(){return i[e]})}(o);t("aaf1");var r,s=t("f0c5"),a=Object(s["a"])(i["default"],n["b"],n["c"],!1,null,null,null,!1,n["a"],r);c["default"]=a.exports},"1c3d":function(e,c,t){"use strict";(function(e){Object.defineProperty(c,"__esModule",{value:!0}),c.default=void 0;var n=t("0c81"),i=t("2f62");function o(e){for(var c=1;c<arguments.length;c++){var t=null!=arguments[c]?arguments[c]:{},n=Object.keys(t);"function"===typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(t).filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.forEach(function(c){r(e,c,t[c])})}return e}function r(e,c,t){return c in e?Object.defineProperty(e,c,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[c]=t,e}var s={data:function(){return{checkV:!0,defaultImg:"../../static/prod.png",youhuiCode:null,placeholder:"兑换码不区分大小写",cansubmit:!0,canSubmitClass:"submit-button",canNotSubmitClass:"can-not-submit"}},methods:o({},(0,i.mapMutations)(["setUserId","setDeviceId","setDeviceName","setDeviceImei","setResponseOrder","setIsFirst","setBlueToothOpen"]),{changeRadioV:function(){this.checkV=!this.checkV},oepnxieyi:function(){e.showModal({title:"用户协议",content:this.machObject.userProtocol,showCancel:!1,success:function(e){e.confirm}})},gotoPay:function(){var c=this;if(c.cansubmit){if(!c.checkV)return void e.showToast({title:"请同意用户协议",icon:"none",mask:!0,duration:1500});c.cansubmit=!1,c.bleConnected?(e.showLoading({title:"加载中"}),c.commitOrderRequstNetWork()):e.showModal({title:"",content:"设备连接中，请稍后",showCancel:!1,success:function(e){e.confirm}})}},commitOrderRequstNetWork:function(){var c=this;e.request({url:c.baseRequestUrl+"microProgramOrder/commitWeixinMicroOrder",method:"POST",data:{orderFrom:"wx_fmj",userId:c.userId,deviceImei:c.deviceImei,voucherCode:c.youhuiCode,goodsInfo:JSON.stringify(c.commitGoodsArray)},success:function(t){var i=t.data;1===i.code?e.requestPayment({provider:"wxpay",timeStamp:i.timeStamp,nonceStr:i.nonceStr,package:"prepay_id="+i.prepayId,signType:"MD5",paySign:i.sign,success:function(t){e.request({url:c.baseRequestUrl+"order/getRealOrder?sysOrderId="+i.sysOrderId,success:function(t){if(1===t.data.code){var i=t.data.order;i.length<=40?e.writeBLECharacteristicValue({deviceId:c.deviceId,serviceId:"6E400001-B5A3-F393-E0A9-E50E24DCCA9E",characteristicId:"6E400002-B5A3-F393-E0A9-E50E24DCCA9E",value:(0,n.String2Ab)(i),success:function(t){console.warn("下发真实命令成功",t),e.writeBLECharacteristicValue({deviceId:c.deviceId,serviceId:"6E400001-B5A3-F393-E0A9-E50E24DCCA9E",characteristicId:"6E400002-B5A3-F393-E0A9-E50E24DCCA9E",value:(0,n.String2Ab)(c.confirmOrder),success:function(c){console.warn("下发确认命令成功",c),e.hideLoading(),e.redirectTo({url:"../buyfinish/buyfinish",complete:function(e){console.error("路由执行成功，结果为：",e)}})},fail:function(e){console.warn("下发确认命令失败",e)}})},fail:function(e){console.warn("下发真实命令失败",e)}}):function(){var t=Math.floor(i.length/40);c.setResponseOrder("");for(var o=function(o){e.writeBLECharacteristicValue({deviceId:c.deviceId,serviceId:"6E400001-B5A3-F393-E0A9-E50E24DCCA9E",characteristicId:"6E400002-B5A3-F393-E0A9-E50E24DCCA9E",value:(0,n.String2Ab)(i.substring(40*o,40*(o+1))),success:function(i){(0,n.sleep)(200),o==t&&e.writeBLECharacteristicValue({deviceId:c.deviceId,serviceId:"6E400001-B5A3-F393-E0A9-E50E24DCCA9E",characteristicId:"6E400002-B5A3-F393-E0A9-E50E24DCCA9E",value:(0,n.String2Ab)(c.confirmOrder),success:function(c){e.hideLoading(),e.redirectTo({url:"../buyfinish/buyfinish",complete:function(e){console.error("路由执行成功，结果为：",e)}})}})}})},r=0;r<=t;r++)o(r)}()}else e.showModal({title:"",content:"服务器开小差,请稍后重试",showCancel:!1,success:function(c){c.confirm&&e.reLaunch({url:"../index/index"})}})}})},fail:function(t){e.hideLoading(),c.cansubmit=!0,console.error("支付失败"+JSON.stringify(t))}}):e.showModal({title:"",content:i.message,showCancel:!1,success:function(c){c.confirm&&e.reLaunch({url:"../index/index"})}})},fail:function(c){e.showModal({title:"",content:"服务器开小差,请稍后重试",showCancel:!1,success:function(c){c.confirm&&e.reLaunch({url:"../index/index"})}})}})},closeBle:function(){var c=this;e.closeBLEConnection({deviceId:c.deviceId,success:function(c){e.closeBluetoothAdapter({success:function(e){console.log("页面隐藏后关闭蓝牙成功")}})}})},connectBle:function(){var c=this;if(console.warn("buy页面页面显示获取到的蓝牙状态为",c.blueToothOpen),c.blueToothOpen)if(""!=c.deviceId)e.createBLEConnection({deviceId:c.deviceId,success:function(t){console.log("连接蓝牙成功",t),e.getBLEDeviceCharacteristics({deviceId:c.deviceId,serviceId:"6E400001-B5A3-F393-E0A9-E50E24DCCA9E",success:function(t){e.notifyBLECharacteristicValueChange({state:!0,deviceId:c.deviceId,serviceId:"6E400001-B5A3-F393-E0A9-E50E24DCCA9E",characteristicId:"6E400003-B5A3-F393-E0A9-E50E24DCCA9E",success:function(t){console.log("开启监听服务成功"),e.writeBLECharacteristicValue({deviceId:c.deviceId,serviceId:"6E400001-B5A3-F393-E0A9-E50E24DCCA9E",characteristicId:"6E400002-B5A3-F393-E0A9-E50E24DCCA9E",value:(0,n.String2Ab)("AABB00065130313D3140CB"),success:function(e){console.info("下发在线命令成功"),c.setIsFirst(!1)}})}})}})},fail:function(e){console.warn("重新连接后错误",e)}});else{var t=setTimeout(function(){""==c.deviceId&&(console.error("未搜索到设备"),e.stopBluetoothDevicesDiscovery({success:function(c){e.showModal({title:"",content:"未搜索到设备,请靠近设备后重试",showCancel:!1,success:function(c){c.confirm&&e.reLaunch({url:"../index/index"})}})}}))},5e3);e.startBluetoothDevicesDiscovery({success:function(i){e.onBluetoothDeviceFound(function(i){var o=i.devices[0];console.log("device",o),""!=o.name&&o.name==c.deviceNamePrefix+c.deviceImei&&(clearTimeout(t),c.setDeviceId(o.deviceId),e.stopBluetoothDevicesDiscovery({success:function(t){console.log("找到设备后关闭发现服务成功",o.deviceId),e.createBLEConnection({deviceId:o.deviceId,success:function(t){console.log("连接蓝牙成功",t),e.getBLEDeviceCharacteristics({deviceId:o.deviceId,serviceId:"6E400001-B5A3-F393-E0A9-E50E24DCCA9E",success:function(t){e.notifyBLECharacteristicValueChange({state:!0,deviceId:o.deviceId,serviceId:"6E400001-B5A3-F393-E0A9-E50E24DCCA9E",characteristicId:"6E400003-B5A3-F393-E0A9-E50E24DCCA9E",success:function(t){console.log("开启监听服务成功"),e.writeBLECharacteristicValue({deviceId:o.deviceId,serviceId:"6E400001-B5A3-F393-E0A9-E50E24DCCA9E",characteristicId:"6E400002-B5A3-F393-E0A9-E50E24DCCA9E",value:(0,n.String2Ab)("AABB00065130313D3140CB"),success:function(e){console.info("下发Q01成功"),c.setIsFirst(!1)}})}})}})}})}}))})}})}else e.showModal({title:"提示",content:"请开启手机蓝牙",showCancel:!1,success:function(e){e.confirm&&console.info("提示用户开启蓝牙后用户点击确认")}})},getAndListenBTState:function(){var c=this;e.openBluetoothAdapter({success:function(e){console.warn("开启适配器状态成功，意味着蓝牙开启",e),c.setBlueToothOpen(!0),c.connectBle()},fail:function(e){console.warn("开启适配器失败，意味着没有开启蓝牙",e),c.connectBle()}})},listenResponseOrder:function(){var c=this,t=0;e.onBLECharacteristicValueChange(function(e){if((new Date).getTime()-t<200)c.setResponseOrder(c.responseOrder+(0,n.Ab2String)(e.value)),console.log("分包相应的结果合并为",c.responseOrder);else{t=(new Date).getTime();var i=(0,n.Ab2String)(e.value);if(-1!=i.indexOf("5130383D")){var o=i.substring(8,12);c.setbattery(parseInt(String.fromCharCode(parseInt(o.substring(0,2),16))+String.fromCharCode(parseInt(o.substring(2),16))))}else c.setResponseOrder(i);console.log("监听到设备的响应为",i)}})}}),computed:o({},(0,i.mapState)(["baseRequestUrl","deviceNamePrefix","deviceImei","deviceName","deviceId","responseOrder","confirmOrder","goodsObjectArray","commitGoodsArray","userId","bleConnected","mainUUID","writeUUID","notifyUUID","blueToothOpen"]),{totalPrice:function(){for(var e=0,c=this.goodsObjectArray,t=0;t<c.length;t++){var n=c[t];e+=n.product.goods.price*n.number}return e},buttonMsg:function(){return this.cansubmit&&this.bleConnected?"立即支付":"订单加载中"}}),onShow:function(){},onLoad:function(){}};c.default=s}).call(this,t("543d")["default"])},"37bf":function(e,c,t){},9641:function(e,c,t){"use strict";var n,i=function(){var e=this,c=e.$createElement;e._self._c},o=[];t.d(c,"b",function(){return i}),t.d(c,"c",function(){return o}),t.d(c,"a",function(){return n})},aaf1:function(e,c,t){"use strict";var n=t("37bf"),i=t.n(n);i.a},c6fa:function(e,c,t){"use strict";(function(e){t("6a51"),t("921b");n(t("66fd"));var c=n(t("1c2e"));function n(e){return e&&e.__esModule?e:{default:e}}e(c.default)}).call(this,t("543d")["createPage"])},daa4:function(e,c,t){"use strict";t.r(c);var n=t("1c3d"),i=t.n(n);for(var o in n)"default"!==o&&function(e){t.d(c,e,function(){return n[e]})}(o);c["default"]=i.a}},[["c6fa","common/runtime","common/vendor"]]]);